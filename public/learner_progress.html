<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Learner Progress</title>
  <link rel="stylesheet" href="../assets/css/layout.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo">GibJohn Learning</a>
      <button class="hamburger" type="button" aria-label="Toggle navigation" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <nav class="nav-links">
        <a href="tutor_dashboard.html">Dashboard</a>
        <a href="index.html">Home</a>
        <a href="/gibjohn/api/auth/logout.php">Logout</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="page-header" aria-labelledby="page-title">
        <h1 id="page-title" class="page-title">Learner Progress</h1>
        <p id="page-subtitle" class="page-subtitle">Loading learner details...</p>
      </section>

      <section aria-labelledby="subjects-heading">
        <h2 id="subjects-heading" class="section-title">Subject Progress</h2>
        <div id="progress-container" class="subject-grid">
          <p class="status-message">Loading progress...</p>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>Gibjohn Tutoring</p>
    </div>
  </footer>

  <script>
    const progressContainer = document.querySelector("#progress-container");
    const subtitle = document.querySelector("#page-subtitle");
    const params = new URLSearchParams(window.location.search);
    const learnerId = params.get("learner_id");

    function showMessage(text, isError, isEmpty) {
      progressContainer.textContent = "";
      const paragraph = document.createElement("p");
      paragraph.className = isError ? "status-message error" : "status-message";
      paragraph.textContent = text;

      if (isEmpty) {
        paragraph.className += " empty-state";
      }

      progressContainer.appendChild(paragraph);
    }

    function parseJson(raw) {
      try {
        return JSON.parse(raw);
      } catch (error) {
        return null;
      }
    }

    function clampProgress(value) {
      const numericValue = Number(value);

      if (Number.isNaN(numericValue)) {
        return 0;
      }

      return Math.max(0, Math.min(100, numericValue));
    }

    function createSubjectCard(subject) {
      const subjectName = subject && subject.name ? subject.name : "Untitled subject";
      const subjectDescription = subject && subject.description ? subject.description : "No description available.";
      const totalContent = Number(subject && subject.total_content ? subject.total_content : 0);
      const completedContent = Number(subject && subject.completed_content ? subject.completed_content : 0);
      const progressPercentage = clampProgress(subject && subject.progress_percentage);

      const card = document.createElement("article");
      card.className = "card subject-card";

      const title = document.createElement("h3");
      title.textContent = subjectName;

      const description = document.createElement("p");
      description.className = "subject-description";
      description.textContent = subjectDescription;

      const footer = document.createElement("div");
      footer.className = "subject-footer";

      const progressText = document.createElement("p");
      progressText.className = "progress-text";
      progressText.textContent = completedContent + " / " + totalContent + " completed (" + progressPercentage + "%)";

      const progressBar = document.createElement("progress");
      progressBar.className = "progress-meter";
      progressBar.max = 100;
      progressBar.value = progressPercentage;
      progressBar.setAttribute("aria-label", "Progress");

      footer.appendChild(progressText);
      footer.appendChild(progressBar);

      card.appendChild(title);
      card.appendChild(description);
      card.appendChild(footer);

      return card;
    }

    if (!learnerId) {
      subtitle.textContent = "Learner ID is missing.";
      showMessage("Missing learner_id in URL.", true, false);
    } else {
      fetch("/gibjohn/api/tutor/get_learner_progress.php?learner_id=" + encodeURIComponent(learnerId))
        .then(function (response) {
          return response.text().then(function (raw) {
            return {
              response: response,
              data: parseJson(raw)
            };
          });
        })
        .then(function (result) {
          if (!result.response.ok || !result.data || result.data.error) {
            throw new Error((result.data && result.data.error) ? result.data.error : "Unable to load learner progress.");
          }

          const learnerEmail = result.data.learner && result.data.learner.email
            ? result.data.learner.email
            : "Selected learner";
          subtitle.textContent = "Read-only progress overview for " + learnerEmail + ".";

          const subjects = Array.isArray(result.data.subjects) ? result.data.subjects : [];

          if (subjects.length === 0) {
            showMessage("No subject data found for this learner.", false, true);
            return;
          }

          progressContainer.textContent = "";
          subjects.forEach(function (subject) {
            progressContainer.appendChild(createSubjectCard(subject));
          });
        })
        .catch(function (error) {
          subtitle.textContent = "Unable to load learner details.";
          showMessage(error.message || "Unable to load learner progress right now.", true, false);
        });
    }
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const hamburger = document.querySelector(".hamburger");
      const navLinks = document.querySelector(".nav-links");

      if (!hamburger || !navLinks) {
        return;
      }

      hamburger.addEventListener("click", function () {
        const isOpen = navLinks.classList.toggle("is-open");
        hamburger.classList.toggle("is-open", isOpen);
        hamburger.setAttribute("aria-expanded", isOpen ? "true" : "false");
      });

      navLinks.querySelectorAll("a").forEach(function (link) {
        link.addEventListener("click", function () {
          navLinks.classList.remove("is-open");
          hamburger.classList.remove("is-open");
          hamburger.setAttribute("aria-expanded", "false");
        });
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Content</title>
  <link rel="stylesheet" href="../assets/css/layout.css">
</head>
<body class="app-shell">
  <header class="mobile-topbar" aria-label="Mobile navigation bar">
    <button class="hamburger" type="button" aria-label="Toggle sidebar" aria-expanded="false" aria-controls="learner-sidebar">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <a href="index.html" class="logo">GibJohn Learning</a>
  </header>

  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <div class="app-layout">
    <aside class="sidebar" id="learner-sidebar" aria-label="Learner sidebar">
      <div class="sidebar-brand">
        <a href="index.html" class="logo">GibJohn Learning</a>
      </div>
      <nav class="sidebar-nav" aria-label="Learner navigation">
        <a href="learner_dashboard.html">Dashboard</a>
        <a href="learner_dashboard.html#activity-overview">Progress</a>
        <a href="profile.html">Profile</a>
        <a href="#" aria-disabled="true">Settings</a>
      </nav>
      <div class="sidebar-footer">
        <a class="btn btn-primary" href="/gibjohn/api/auth/logout.php">Logout</a>
      </div>
    </aside>

    <main class="main-content">
      <div class="main-content-inner">
        <section class="page-header" aria-labelledby="subject-title">
          <h1 id="subject-title" class="page-title">Subject Practice</h1>
          <p class="page-subtitle">Answer each prompt and complete the activity to continue.</p>
        </section>

        <section class="question-layout" aria-live="polite">
          <div class="question-topbar">
            <button type="button" class="btn btn-secondary" id="back-button">Back to Dashboard</button>
            <div class="question-progress">
              <p id="question-counter" class="question-counter">Question 0 / 0</p>
              <progress id="question-progress-bar" class="progress-meter" max="100" value="0" aria-label="Subject completion"></progress>
              <div id="progress-dots" class="progress-indicator-dots" aria-hidden="true"></div>
            </div>
          </div>

          <p id="reward-message" class="status-message reward-notice" hidden aria-live="polite"></p>
          <p id="error-message" class="status-message error" hidden></p>

          <article class="card question-card" id="question-card">
            <h2 class="section-title" id="question-title">Loading question...</h2>
            <p id="question-text" class="content-text">Please wait while content loads.</p>
            <div class="diagram-placeholder" aria-hidden="true">Diagram Placeholder</div>

            <div id="answer-options" class="answer-options"></div>

            <div class="question-actions">
              <button type="button" class="btn btn-primary" id="submit-answer" disabled>Submit Answer</button>
            </div>
          </article>

          <article id="result-card" class="card result-card" hidden>
            <h3>Answer Submitted</h3>
            <p id="result-text" class="subject-meta">Your response has been recorded.</p>
            <div class="question-actions">
              <button type="button" class="btn btn-primary" id="continue-button">Continue</button>
            </div>
          </article>
        </section>

        <section class="completed-history-section" aria-labelledby="completed-history-title">
          <h2 id="completed-history-title" class="section-title">Completed Activities</h2>
          <div id="completed-history" class="content-stack">
            <p class="status-message empty-state">No completed activities yet.</p>
          </div>
        </section>
      </div>

          <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-brand">
        <h3>GibJohn Tutoring</h3>
        <p>Structured learning. Real progress.</p>
      </div>

      <div class="footer-links">
        <a href="index.html" id="footer-home">Home</a>
        <a href="learner_dashboard.html" id="footer-dashboard" hidden>Dashboard</a>
        <a href="login.html" id="footer-login">Login</a>
        <a href="register.html" id="footer-register">Register</a>
        <a href="/gibjohn/api/auth/logout.php" id="footer-logout" hidden>Logout</a>
      </div>
    </div>

    <div class="footer-bottom">
      Â© 2026 GibJohn Tutoring. All rights reserved.
    </div>
  </footer>
    </main>
  </div>

  <script>
    const rewardMessage = document.querySelector("#reward-message");
    const errorMessage = document.querySelector("#error-message");
    const questionTitle = document.querySelector("#question-title");
    const questionText = document.querySelector("#question-text");
    const answerOptions = document.querySelector("#answer-options");
    const submitAnswer = document.querySelector("#submit-answer");
    const continueButton = document.querySelector("#continue-button");
    const resultCard = document.querySelector("#result-card");
    const resultText = document.querySelector("#result-text");
    const questionCounter = document.querySelector("#question-counter");
    const questionProgressBar = document.querySelector("#question-progress-bar");
    const progressDots = document.querySelector("#progress-dots");
    const backButton = document.querySelector("#back-button");
    const completedHistory = document.querySelector("#completed-history");

    const params = new URLSearchParams(window.location.search);
    const subjectId = params.get("subject_id");

    const optionLabels = [
      "I can explain this clearly.",
      "I understand most of it.",
      "I need a quick revision.",
      "I need tutor support."
    ];

    let contentItems = [];
    let currentIndex = 0;
    let selectedOption = "";
    let submitted = false;

    function showError(text) {
      errorMessage.hidden = false;
      errorMessage.textContent = text;
    }

    function clearError() {
      errorMessage.hidden = true;
      errorMessage.textContent = "";
    }

    function parseJsonSafely(rawText) {
      try {
        return JSON.parse(rawText);
      } catch (error) {
        return null;
      }
    }

    function toContentItems(data) {
      if (data && Array.isArray(data.content)) {
        return data.content;
      }

      if (Array.isArray(data)) {
        return data;
      }

      return [];
    }

    function getCompletedCount() {
      return contentItems.filter(function (item) {
        return Number(item && item.completed) === 1;
      }).length;
    }

    function updateProgressUI() {
      const total = contentItems.length;
      const currentQuestionNumber = total === 0 ? 0 : Math.min(currentIndex + 1, total);
      const completed = getCompletedCount();
      const progressValue = total > 0 ? Math.round((completed / total) * 100) : 0;

      questionCounter.textContent = "Question " + currentQuestionNumber + " / " + total;
      questionProgressBar.value = progressValue;

      progressDots.textContent = "";
      contentItems.forEach(function (item, index) {
        const dot = document.createElement("span");
        dot.className = "dot";

        if (Number(item && item.completed) === 1) {
          dot.classList.add("completed");
        } else if (index === currentIndex) {
          dot.classList.add("current");
        }

        progressDots.appendChild(dot);
      });
    }

    function renderCompletedHistory() {
      if (!completedHistory) {
        return;
      }

      completedHistory.textContent = "";
      const completedItems = contentItems.filter(function (item) {
        return Number(item && item.completed) === 1;
      });

      if (completedItems.length === 0) {
        const emptyMessage = document.createElement("p");
        emptyMessage.className = "status-message empty-state";
        emptyMessage.textContent = "No completed activities yet.";
        completedHistory.appendChild(emptyMessage);
        return;
      }

      completedItems.forEach(function (item) {
        const card = document.createElement("article");
        card.className = "card content-card is-completed";

        const meta = document.createElement("div");
        meta.className = "content-meta";

        const title = document.createElement("h3");
        title.textContent = "Activity " + String(item && item.content_order ? item.content_order : "?");

        const status = document.createElement("span");
        status.className = "status-badge completed";
        status.textContent = "Completed";

        const text = document.createElement("p");
        text.className = "content-text";
        text.textContent = item && item.content_text ? item.content_text : "No content text available.";

        meta.appendChild(title);
        meta.appendChild(status);
        card.appendChild(meta);
        card.appendChild(text);
        completedHistory.appendChild(card);
      });
    }

    function renderAnswerOptions() {
      answerOptions.textContent = "";

      optionLabels.forEach(function (label) {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "answer-option";
        button.textContent = label;

        if (selectedOption === label) {
          button.classList.add("selected");
        }

        button.addEventListener("click", function () {
          selectedOption = label;
          submitAnswer.disabled = false;
          renderAnswerOptions();
        });

        answerOptions.appendChild(button);
      });
    }

    function renderQuestion() {
      clearError();
      resultCard.hidden = true;
      submitted = false;
      selectedOption = "";
      submitAnswer.disabled = true;

      if (contentItems.length === 0) {
        questionTitle.textContent = "No Content Found";
        questionText.textContent = "No learning activities are available for this subject yet.";
        answerOptions.textContent = "";
        updateProgressUI();
        renderCompletedHistory();
        return;
      }

      if (currentIndex >= contentItems.length) {
        questionTitle.textContent = "Subject Completed";
        questionText.textContent = "You have completed all activities in this subject.";
        answerOptions.textContent = "";
        submitAnswer.disabled = true;
        updateProgressUI();
        renderCompletedHistory();
        return;
      }

      const item = contentItems[currentIndex];
      questionTitle.textContent = "Activity " + (currentIndex + 1);
      questionText.textContent = item && item.content_text ? item.content_text : "No content text available.";
      renderAnswerOptions();
      updateProgressUI();
      renderCompletedHistory();

      if (Number(item && item.completed) === 1) {
        resultCard.hidden = false;
        resultText.textContent = "This activity is already completed. Continue to the next one.";
      }
    }

    function showRewardMessage(reward) {
      if (!reward || !reward.name) {
        return;
      }

      rewardMessage.hidden = false;
      rewardMessage.className = "status-message reward-notice";
      rewardMessage.textContent = "Reward earned: " + reward.name;
    }

    function getRewardNameFromResponse(data) {
      if (!data) {
        return null;
      }

      if (data.reward && typeof data.reward === "string") {
        return data.reward;
      }

      if (data.reward && typeof data.reward === "object") {
        if (data.reward.name) {
          return data.reward.name;
        }

        if (data.reward.badge_name) {
          return data.reward.badge_name;
        }

        if (data.reward.reward_type) {
          return data.reward.reward_type;
        }
      }

      if (typeof data.new_reward === "string" && data.new_reward.trim() !== "") {
        return data.new_reward;
      }

      return null;
    }

    async function markComplete(contentId) {
      const formData = new FormData();
      formData.append("content_id", contentId);

      const response = await fetch("/gibjohn/api/learner/complete_activity.php", {
        method: "POST",
        body: formData
      });

      const raw = await response.text();
      const data = parseJsonSafely(raw);

      if (!response.ok || !data || data.success !== true) {
        throw new Error((data && data.error) ? data.error : "Could not mark complete.");
      }

      const rewardName = getRewardNameFromResponse(data);
      if (rewardName) {
        showRewardMessage({ name: rewardName });
      }
    }

    function moveToNextQuestion() {
      if (currentIndex < contentItems.length - 1) {
        currentIndex += 1;
      } else {
        currentIndex = contentItems.length;
      }

      renderQuestion();
    }

    submitAnswer.addEventListener("click", function () {
      if (!selectedOption || currentIndex >= contentItems.length) {
        return;
      }

      submitted = true;
      resultCard.hidden = false;
      resultText.textContent = "Answer saved. Click continue to mark this activity complete.";
    });

    continueButton.addEventListener("click", async function () {
      if (!submitted && currentIndex < contentItems.length && Number(contentItems[currentIndex].completed) !== 1) {
        return;
      }

      if (currentIndex >= contentItems.length) {
        window.location.href = "learner_dashboard.html";
        return;
      }

      const item = contentItems[currentIndex];

      if (Number(item && item.completed) === 1) {
        moveToNextQuestion();
        return;
      }

      continueButton.disabled = true;
      continueButton.textContent = "Saving...";

      try {
        await markComplete(item.id);
        item.completed = 1;
        moveToNextQuestion();
      } catch (error) {
        showError(error.message || "Unable to mark content complete.");
      } finally {
        continueButton.disabled = false;
        continueButton.textContent = "Continue";
      }
    });

    backButton.addEventListener("click", function () {
      window.location.href = "learner_dashboard.html";
    });

    if (!subjectId) {
      showError("Missing subject_id in URL.");
      questionTitle.textContent = "Invalid Subject";
      questionText.textContent = "Open a subject from your dashboard to continue.";
      submitAnswer.disabled = true;
    } else {
      fetch("/gibjohn/api/learner/get_content.php?subject_id=" + encodeURIComponent(subjectId))
        .then(function (response) {
          return response.text().then(function (raw) {
            return { response: response, raw: raw };
          });
        })
        .then(function (result) {
          const data = parseJsonSafely(result.raw);

          if (!result.response.ok || !data || data.error) {
            throw new Error((data && data.error) ? data.error : "Failed to load subject content.");
          }

          contentItems = toContentItems(data);
          currentIndex = contentItems.findIndex(function (item) {
            return Number(item && item.completed) !== 1;
          });

          if (currentIndex < 0) {
            currentIndex = contentItems.length;
          }

          renderQuestion();
        })
        .catch(function (error) {
          showError(error.message || "Unable to load subject content.");
          questionTitle.textContent = "Load Error";
          questionText.textContent = "Please go back and try again.";
          submitAnswer.disabled = true;
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const hamburger = document.querySelector(".mobile-topbar .hamburger");
      const sidebar = document.querySelector(".sidebar");
      const overlay = document.querySelector("#sidebar-overlay");

      function closeSidebar() {
        if (!hamburger || !sidebar || !overlay) {
          return;
        }

        sidebar.classList.remove("is-open");
        overlay.classList.remove("is-visible");
        hamburger.classList.remove("is-open");
        hamburger.setAttribute("aria-expanded", "false");
        document.body.classList.remove("menu-open");
      }

      if (!hamburger || !sidebar || !overlay) {
        return;
      }

      hamburger.addEventListener("click", function () {
        const isOpen = sidebar.classList.toggle("is-open");
        overlay.classList.toggle("is-visible", isOpen);
        hamburger.classList.toggle("is-open", isOpen);
        hamburger.setAttribute("aria-expanded", isOpen ? "true" : "false");
        document.body.classList.toggle("menu-open", isOpen);
      });

      overlay.addEventListener("click", closeSidebar);

      document.querySelectorAll(".sidebar-nav a, .sidebar-footer a").forEach(function (link) {
        link.addEventListener("click", function () {
          closeSidebar();
        });
      });
    });
  </script>
  <script>
    (function footerAuthToggle() {
      const footerDashboard = document.querySelector("#footer-dashboard");
      const footerLogin = document.querySelector("#footer-login");
      const footerRegister = document.querySelector("#footer-register");
      const footerLogout = document.querySelector("#footer-logout");

      if (!footerDashboard || !footerLogin || !footerRegister || !footerLogout) {
        return;
      }

      function getDashboardPath(role) {
        if (role === "tutor") {
          return "tutor_dashboard.html";
        }

        return "learner_dashboard.html";
      }

      fetch("/gibjohn/api/auth/me.php")
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data && data.success === true && data.logged_in === true) {
            footerDashboard.hidden = false;
            footerLogout.hidden = false;
            footerLogin.hidden = true;
            footerRegister.hidden = true;
            footerDashboard.setAttribute("href", getDashboardPath(data.role));
          } else {
            footerDashboard.hidden = true;
            footerLogout.hidden = true;
            footerLogin.hidden = false;
            footerRegister.hidden = false;
          }
        })
        .catch(function () {
          footerDashboard.hidden = true;
          footerLogout.hidden = true;
          footerLogin.hidden = false;
          footerRegister.hidden = false;
        });
    })();
  </script>
</body>
</html>

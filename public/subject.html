<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Content</title>
  <link rel="stylesheet" href="../assets/css/layout.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo">GibJohn Learning</a>
      <button class="hamburger" type="button" aria-label="Toggle navigation" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <nav class="nav-links">
        <a href="learner_dashboard.html">Dashboard</a>
        <a href="profile.html">Profile</a>
        <a href="/gibjohn/api/auth/logout.php">Logout</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="page-header" aria-labelledby="subject-title">
        <h1 id="subject-title" class="page-title">Subject Content</h1>
        <p class="page-subtitle">Complete each learning activity in order and track your progress.</p>
      </section>

      <section aria-labelledby="content-heading">
        <h2 id="content-heading" class="section-title">Learning Activities</h2>
        <p id="reward-message" class="status-message reward-notice" hidden aria-live="polite"></p>
        <div id="content-container" class="content-stack">
          <p class="status-message">Loading content...</p>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>Gibjohn Tutoring</p>
    </div>
  </footer>

  <script>
    const contentContainer = document.querySelector("#content-container");
    const rewardMessage = document.querySelector("#reward-message");
    const params = new URLSearchParams(window.location.search);
    const subjectId = params.get("subject_id");

    function showMessage(text, isError, isEmpty) {
      contentContainer.textContent = "";
      const message = document.createElement("p");
      message.className = isError ? "status-message error" : "status-message";

      if (isEmpty) {
        message.className += " empty-state";
      }

      message.textContent = text;
      contentContainer.appendChild(message);
    }

    function parseJsonSafely(rawText) {
      try {
        return JSON.parse(rawText);
      } catch (error) {
        return null;
      }
    }

    function toContentItems(data) {
      if (data && Array.isArray(data.content)) {
        return data.content;
      }

      if (Array.isArray(data)) {
        return data;
      }

      return [];
    }

    function setCompletedState(card, badge, button) {
      card.classList.add("is-completed");
      badge.className = "status-badge completed";
      badge.textContent = "Completed";
      button.textContent = "Completed";
      button.disabled = true;
    }

    function showRewardMessage(reward) {
      if (!rewardMessage || !reward || !reward.name) {
        return;
      }

      rewardMessage.hidden = false;
      rewardMessage.className = "status-message reward-notice";
      rewardMessage.textContent = "Reward earned: " + reward.name;
    }

    async function markComplete(contentId, button, card, badge) {
      button.disabled = true;
      button.textContent = "Saving...";

      try {
        const formData = new FormData();
        formData.append("content_id", contentId);

        const response = await fetch("/gibjohn/api/learner/complete_activity.php", {
          method: "POST",
          body: formData
        });

        const raw = await response.text();
        const data = parseJsonSafely(raw);

        if (!response.ok || !data || data.success !== true) {
          throw new Error((data && data.error) ? data.error : "Could not mark complete.");
        }

        setCompletedState(card, badge, button);

        if (data.reward && data.reward.name) {
          showRewardMessage(data.reward);
        } else if (data.new_reward) {
          showRewardMessage({ name: data.new_reward });
        }
      } catch (error) {
        button.disabled = false;
        button.textContent = "Mark Complete";
        showMessage(error.message || "Unable to mark content complete.", true, false);
      }
    }

    function renderContentItems(items) {
      if (!Array.isArray(items) || items.length === 0) {
        showMessage("No content found for this subject.", false, true);
        return;
      }

      contentContainer.textContent = "";

      items.forEach(function (item, index) {
        const card = document.createElement("article");
        card.className = "card content-card";

        const meta = document.createElement("div");
        meta.className = "content-meta";

        const title = document.createElement("h3");
        title.textContent = "Activity " + (index + 1);

        const badge = document.createElement("span");
        badge.className = "status-badge";
        badge.textContent = "Pending";

        const text = document.createElement("p");
        text.className = "content-text";
        text.textContent = item && item.content_text ? item.content_text : "No content text available.";

        const actions = document.createElement("div");
        actions.className = "content-actions";

        const button = document.createElement("button");
        button.type = "button";
        button.className = "btn btn-primary";
        button.textContent = "Mark Complete";

        const isCompleted = Number(item && item.completed) === 1;
        if (isCompleted) {
          setCompletedState(card, badge, button);
        } else {
          button.addEventListener("click", function () {
            markComplete(item.id, button, card, badge);
          });
        }

        meta.appendChild(title);
        meta.appendChild(badge);
        actions.appendChild(button);

        card.appendChild(meta);
        card.appendChild(text);
        card.appendChild(actions);
        contentContainer.appendChild(card);
      });
    }

    if (!subjectId) {
      showMessage("Missing subject_id in URL.", true, false);
    } else {
      fetch("/gibjohn/api/learner/get_content.php?subject_id=" + encodeURIComponent(subjectId))
        .then(function (response) {
          return response.text().then(function (raw) {
            return { response: response, raw: raw };
          });
        })
        .then(function (result) {
          const data = parseJsonSafely(result.raw);

          if (!result.response.ok || !data || data.error) {
            throw new Error((data && data.error) ? data.error : "Failed to load subject content.");
          }

          renderContentItems(toContentItems(data));
        })
        .catch(function (error) {
          showMessage(error.message || "Unable to load subject content.", true, false);
        });
    }
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const hamburger = document.querySelector(".hamburger");
      const navLinks = document.querySelector(".nav-links");

      if (!hamburger || !navLinks) {
        return;
      }

      hamburger.addEventListener("click", function () {
        const isOpen = navLinks.classList.toggle("is-open");
        hamburger.classList.toggle("is-open", isOpen);
        hamburger.setAttribute("aria-expanded", isOpen ? "true" : "false");
      });

      navLinks.querySelectorAll("a").forEach(function (link) {
        link.addEventListener("click", function () {
          navLinks.classList.remove("is-open");
          hamburger.classList.remove("is-open");
          hamburger.setAttribute("aria-expanded", "false");
        });
      });
    });
  </script>
</body>
</html>
